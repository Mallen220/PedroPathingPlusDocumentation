---
interface Props {
  content: string;
}

const { content } = Astro.props;
const id = 'copy-dropdown-' + Math.random().toString(36).substr(2, 9);
---

<div id={id} class="copy-dropdown-container">
  <button class="copy-dropdown-btn" aria-haspopup="true" aria-expanded="false" aria-label="Copy options">
    Copy
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="chevron"><polyline points="6 9 12 15 18 9"></polyline></svg>
  </button>
  <div class="copy-dropdown-menu" role="menu" hidden>
    <button class="dropdown-item copy-page-btn" role="menuitem">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
      Copy page
    </button>
    <button class="dropdown-item view-markdown-btn" role="menuitem">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
      View as Markdown
    </button>
  </div>
</div>

<script define:vars={{ content, id }}>
  const container = document.getElementById(id);
  const btn = container.querySelector('.copy-dropdown-btn');
  const menu = container.querySelector('.copy-dropdown-menu');
  const copyBtn = container.querySelector('.copy-page-btn');
  const viewBtn = container.querySelector('.view-markdown-btn');

  function toggleMenu() {
    const isExpanded = btn.getAttribute('aria-expanded') === 'true';
    btn.setAttribute('aria-expanded', !isExpanded);
    menu.hidden = isExpanded;
  }

  // Close menu when clicking outside
  document.addEventListener('click', (e) => {
    if (!container.contains(e.target)) {
      btn.setAttribute('aria-expanded', 'false');
      menu.hidden = true;
    }
  });

  btn.addEventListener('click', (e) => {
    e.stopPropagation();
    toggleMenu();
  });

  copyBtn.addEventListener('click', async (e) => {
    e.stopPropagation();
    try {
      await navigator.clipboard.writeText(content);
      const originalHTML = copyBtn.innerHTML;
      copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg> Copied!';
      setTimeout(() => {
        copyBtn.innerHTML = originalHTML;
        toggleMenu(); // Close menu after copy
      }, 2000);
    } catch (err) {
      console.error('Failed to copy!', err);
    }
  });

  viewBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    const blob = new Blob([content], { type: 'text/markdown' });
    const url = URL.createObjectURL(blob);
    window.open(url, '_blank');
    toggleMenu();
  });
</script>

<style>
  .copy-dropdown-container {
    position: relative;
    display: inline-block;
    margin-left: 1rem;
    vertical-align: middle;
  }

  .copy-dropdown-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.25rem 0.75rem;
    border: 1px solid var(--sl-color-gray-5);
    background-color: transparent;
    color: var(--sl-color-gray-2);
    border-radius: 0.25rem;
    cursor: pointer;
    font-size: var(--sl-text-sm);
    transition: all 0.2s ease;
    font-weight: 500;
  }

  .copy-dropdown-btn:hover {
    background-color: var(--sl-color-gray-6);
    color: var(--sl-color-white);
    border-color: var(--sl-color-gray-4);
  }

  .copy-dropdown-menu {
    position: absolute;
    top: 100%;
    right: 0;
    margin-top: 0.5rem;
    background-color: var(--sl-color-bg-nav);
    border: 1px solid var(--sl-color-gray-5);
    border-radius: 0.5rem;
    box-shadow: var(--sl-shadow-lg);
    z-index: 100;
    min-width: 200px;
    padding: 0.25rem;
    display: flex;
    flex-direction: column;
    gap: 0.125rem;
  }

  .dropdown-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    width: 100%;
    padding: 0.5rem 0.75rem;
    border: none;
    background: none;
    color: var(--sl-color-gray-2);
    text-align: left;
    cursor: pointer;
    font-size: var(--sl-text-sm);
    border-radius: 0.25rem;
    transition: all 0.2s;
  }

  .dropdown-item:hover {
    background-color: var(--sl-color-gray-6);
    color: var(--sl-color-white);
  }

  .dropdown-item svg {
    opacity: 0.8;
  }
</style>
